(()=>{"use strict";var e={20:(e,t,r)=>{var n=r(609),s=Symbol.for("react.element"),a=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,c=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,r){var n,a={},l=null,u=null;for(n in void 0!==r&&(l=""+r),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)o.call(t,n)&&!i.hasOwnProperty(n)&&(a[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===a[n]&&(a[n]=t[n]);return{$$typeof:s,type:e,key:l,ref:u,props:a,_owner:c.current}}t.Fragment=a,t.jsx=l,t.jsxs=l},848:(e,t,r)=>{e.exports=r(20)},609:e=>{e.exports=window.React}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}(()=>{const e=window.wc.blocksCheckout,t=window.wc.wcBlocksRegistry,n=window.wp.element,s=window.wc.wcSettings,a=window.wp.i18n,o=window.wp.data,c=(0,s.getSetting)("revolut_data"),i=(0,s.getSetting)("revolut_data").revolut_pay_data,l=(0,s.getSetting)("revolut_data").revolut_pay_by_bank_data,u=(0,s.getSetting)("revolut_data").revolut_cc_data,d=(0,s.getSetting)("revolut_data").revolut_payment_request_data,p=e=>(0,a.__)(e,"revolut-gateway-for-woocommerce"),m=({endpoint:e,controller:t="revolut_payment_request_"})=>c.fast_checkout_params.ajax_url.toString().replace("%%wc_revolut_gateway_ajax_endpoint%%",`${t}${e}`);function _(e,t,r){const n=e;if(t&&"object"==typeof t)Object.keys(t).forEach((e=>{_(n,t[e],r?`${r}[${e}]`:e)}));else{const e=null==t?"":t;n.append(r,e)}return n}const y=async({data:e,endpoint:t})=>{const r=_(new FormData,e),n=await fetch(t,{method:"POST",body:r});if(!n.ok)throw new Error("Failed to process your request due to network issue");return await n.json()},h=e=>({countryCode:e.country,region:e.state,city:e.city,streetLine1:e.address_1,streetLine2:e.address_2,postcode:e.postcode}),v=e=>({address_1:e.address||e.addressLine.at(0),address_2:e.address_2||e.addressLine.at(1)||"",city:e.city,state:e.state||e.region,postcode:e.postcode||e.postalCode,country:e.country,phone:e.phone}),g=async()=>{const e=await y({endpoint:m({endpoint:O.GET_EXPRESS_CHECKOUT_PARAMS}),data:{security:c.fast_checkout_params.nonce.get_express_checkout_params}});return e?.success?e.revolut_public_id:Promise.reject(new Error("Something went wrong while creating the payment."))},f=async()=>{const e=await y({endpoint:c.route.create_revolut_order,data:{security:c.nonce.create_revolut_order}});if(e?.success)return e;throw new Error("An unexpected error occurred")},b=async e=>(await y({data:{revolut_public_id:e,security:c.fast_checkout_params.nonce.cancel_order},endpoint:m({endpoint:O.CANCEL_ORDER})})).success,w=async e=>{try{if(await b(e))return{type:"error",message:p("Something went wrong, your order has been cancelled.")};throw new Error("Couldn`t cancel the order")}catch(e){return{type:"failure",message:p("Your order has been completed, but we couldn't redirect you to the confirmation page. Please contact us for assistance.")}}},E=async({response:e,paymentMethod:t,shouldSavePayment:r})=>{try{const{processingResponse:n}=e,{wc_order_id:s,revolut_public_id:a,process_payment_result:o}=n.paymentDetails,i=await(async({revolut_public_id:e,shouldSavePayment:t,wc_order_id:r,paymentMethod:n,process_payment_result:s})=>{try{const a={revolut_gateway:n,security:s,revolut_public_id:e,revolut_payment_error:"",wc_order_id:r,reload_checkout:0,revolut_save_payment_method:Number(n===A.REVOLUT_CARD)&&(Number(t)||Number(u.is_save_payment_method_mandatory))},o=await y({data:a,endpoint:c.route.process_order});if("fail"===o?.result)throw new Error(o?.messages||"Something went wrong while trying to charge your card, please try again");if("success"===o?.result)return o;throw new Error("Failed to process your order due to server issue")}catch(e){throw new Error(e.message||"An unexpected error occurred")}})({wc_order_id:s,revolut_public_id:a,shouldSavePayment:r,paymentMethod:t,process_payment_result:o});if(i.redirect)return window.location.href=decodeURI(i.redirect),{type:"success"};throw new Error("Could not redirect you to the confirmation page due to an unexpected error. Please contact the merchant")}catch(e){return{type:"error",message:p(e?.message),retry:!0,messageContext:"wc/checkout/payments"}}},R=async({onSubmit:e,address:t})=>{const{billingAddress:r,shippingAddress:n}=t;let s=r.recipient.indexOf(" "),a=r.recipient.substring(0,s),c=r.recipient.substring(s+1);(0,o.dispatch)(C).setBillingAddress({first_name:a,last_name:c,email:t.email,...v(r)}),(0,o.dispatch)(C).setShippingAddress({first_name:a,last_name:c,...v(n)}),e()},S={channel:"woocommerce-blocks"};let x=null;const k=()=>x||("undefined"!=typeof RevolutUpsell&&(x=RevolutUpsell({locale:c.locale,publicToken:c.merchant_public_key})),x),P=()=>{const e=k();if(!e)return;const t=document.getElementById(j);t&&i.banner.points_banner_enabled&&e.promotionalBanner.mount(t,{amount:c.order.amount,variant:"banner",currency:c.order.currency,__metadata:S})},{CART_STORE_KEY:C,PAYMENT_STORE_KEY:T}=window.wc.wcBlocksData,A={REVOLUT_CARD:"revolut_cc",REVOLUT_PAY:"revolut_pay",REVOLUT_PAY_BY_BANK:"revolut_pay_by_bank",REVOLUT_PRB:"revolut_payment_request"},j="revolut-pay-informational-banner",O={GET_EXPRESS_CHECKOUT_PARAMS:"get_express_checkout_params",UPDATE_SHIPPING_METHOD:"update_shipping_method",GET_SHIPPING_OPTIONS:"get_shipping_options",LOAD_ORDER_DATA:"load_order_data",CANCEL_ORDER:"cancel_order",PROCESS_ORDER:"process_payment_result",UPDATE_PAYMENT_TOTAL:"update_payment_total"},L=["error.3ds-failed","error.email-is-not-specified","error.invalid-postcode","error.invalid-email","error.incorrect-cvv-code","error.expired-card","error.do-not-honour","error.insufficient-funds"],M=({paymentOptions:e,onSuccess:t,onError:r},s)=>{const a=(0,n.useRef)(null),o=(0,n.useRef)();return(0,n.useEffect)((()=>((async()=>{const{paymentRequest:n,destroy:s}=await RevolutCheckout.payments({publicToken:c.merchant_public_key,locale:c.locale});if(o.current=s,a.current){const s=n.mount(a.current,{...e,buttonStyle:{action:d.styles.payment_request_button_type,height:d.styles.payment_request_button_height,variant:d.styles.payment_request_button_theme,radius:d.styles.payment_request_button_radius},currency:c.order.currency,shippingOptions:c.fast_checkout_params.free_shipping_option,onSuccess(){t()},onError(e){r(e.message)},onCancel(){r("Payment cancelled!")}});s.canMakePayment().then((e=>{e?s.render():s.destroy()}))}})(),()=>o.current())),s),{revolutPrbRef:a,destroyRef:o}},N=()=>{(0,n.useEffect)((()=>{const e=document.querySelector(".wp-element-button.wc-block-components-checkout-place-order-button");return e&&(e.disabled=!0,e.style.display="none"),()=>{e&&(e.disabled=!1,e.style.display="block")}}),[])},D=({paymentOptions:e,onSuccess:t,onError:r,onCancel:s},a)=>{const o=(0,n.useRef)(null),l=(0,n.useRef)();return(0,n.useEffect)((()=>((async()=>{const{revolutPay:n,destroy:a}=await RevolutCheckout.payments({publicToken:c.merchant_public_key,locale:c.locale});l.current=a,o.current&&n.mount(o.current,{currency:c.order.currency,totalAmount:0,mobileRedirectUrls:{success:i.mobile_redirect_url,failure:i.mobile_redirect_url,cancel:i.mobile_redirect_url},buttonStyle:{cashbackCurrency:c.order.currency,variant:i.styles.revolut_pay_button_theme,height:i.styles.revolut_pay_button_height,radius:i.styles.revolut_pay_button_radius},...e}),n.on("payment",(e=>{switch(e.type){case"cancel":s();break;case"success":t(e.orderId);break;case"error":r(e.error.message)}}))})(),()=>{l.current()})),a),{revolutPayRef:o,destroyRef:l}};var I=r(848);const U=({settings:e})=>(0,I.jsxs)("div",{className:"revolut-payment-method-label-container",children:[(0,I.jsx)("strong",{children:e.title}),(0,I.jsx)(F,{})]}),B=({settings:e})=>{const{institutions:t,popular_institution_ids:r}=e.pay_by_bank_brands;if(!t||!r)return(0,I.jsx)("div",{className:"revolut-payment-method-label-container",children:(0,I.jsx)("strong",{children:e.title})});const n=[...r.map((e=>t.find((t=>Object.values(t.details)[0].institution_id===e)))).filter(Boolean),...t.filter((e=>!r.includes(Object.values(e.details)[0].institution_id)))],s={firstFive:n.slice(0,5),remainingCount:Math.max(0,n.length-5)};return(0,I.jsxs)("div",{className:"revolut-payment-method-label-container",children:[(0,I.jsx)("strong",{children:e.title}),(0,I.jsxs)("div",{className:"revolut-payment-method-label-scheme-icons",children:[s.firstFive&&s.firstFive.map((e=>(0,I.jsx)("img",{src:e.logo.value,alt:e.name},e.name))),(0,I.jsxs)("strong",{children:["+",s.remainingCount]})]})]})},Y=()=>((0,n.useEffect)((()=>{(()=>{const e=k();if(!e)return;const t=document.getElementById("revolut-pay-label-informational-icon");t&&i.banner.label_icon_variant&&e.promotionalBanner.mount(t,{amount:c.order.amount,variant:"cashback"===i.banner.label_icon_variant?"link":i.banner.label_icon_variant,currency:c.order.currency,style:{text:"cashback"===i.banner.label_icon_variant?"cashback":null,color:"blue"},__metadata:S})})()}),[]),(0,I.jsxs)("div",{className:"revolut-payment-method-label-container",children:[(0,I.jsxs)("div",{className:"revolut-pay-label-title-wrapper",children:[(0,I.jsx)("strong",{style:{whiteSpace:"nowrap"},children:i.title}),(0,I.jsx)("div",{style:{marginLeft:"5px",display:"flex"},id:"revolut-pay-label-informational-icon"})]}),(0,I.jsx)(F,{})]})),F=()=>{const{available_card_brands:e,wc_plugin_url:t}=c;return(0,I.jsx)("div",{className:"revolut-payment-method-label-scheme-icons",children:e&&e.filter((e=>"maestro"!==e)).map((e=>(0,I.jsx)("img",{src:`${t}/assets/images/${e}.svg`,style:{marginLeft:2},alt:e},e)))})},q=({inputRef:e})=>{const[t,r]=(0,n.useState)([]),s=(0,n.useRef)(!1),a=()=>{const t=e.current.value.trim().split(/\s+/).length>1;return!t&&s.current?(e.current.classList.add("wc-revolut-cardholder-name-error"),r([{message:"Please provide your full name"}])):(e.current.classList.remove("wc-revolut-cardholder-name-error"),r([])),t};return e.current&&(e.current.isComplete=()=>(s.current=!0,a())),(0,I.jsxs)("div",{className:"form-row validate-required",id:"cardholder-name","data-priority":"10",style:{display:"block",width:"100%",marginBottom:15},children:[(0,I.jsx)("input",{ref:e,type:"text",onChange:a,className:"input-text",name:"wc-revolut-cardholder-name",id:"wc-revolut-cardholder-name",placeholder:"Cardholder name",autoComplete:"cardholder",required:!0}),(0,I.jsx)("div",{style:{marginBottom:10,marginTop:10},children:(0,I.jsx)(V,{errorList:t})})]})},V=({errorList:e})=>(0,I.jsx)("div",{children:e.map(((e,t)=>(0,I.jsx)("li",{className:"card-field-error",children:e.message},t)))}),G=({orderToken:e})=>((0,n.useEffect)((()=>{(e=>{const t=k();if(!t)return;const r=document.getElementById("revolut-upsell-banner");r&&u.banner.upsell_banner_enabled&&t.cardGatewayBanner.mount(r,{orderToken:e})})(e)}),[e]),(0,I.jsx)("div",{id:"revolut-upsell-banner"})),K=({eventRegistration:e,billing:t,shippingData:r,shouldSavePayment:s,emitResponse:a,components:i,checkoutStatus:l,settings:u})=>{const{onPaymentSetup:d,onCheckoutSuccess:m}=e,_=(0,n.useRef)(),y=(0,n.useRef)(),[v,g]=(0,n.useState)(!1),[b,w]=(0,n.useState)([]),[R,S]=(0,n.useState)(!1),[x,k]=(0,n.useState)(""),[P,C]=(0,n.useState)(0),{createErrorNotice:T,removeAllNotices:j}=(0,o.dispatch)("core/notices");(0,n.useEffect)((()=>{const e=d(M),t=m(N);return()=>{e(),t()}}),[m,d,b,v,s,t.billingAddress,r.shippingAddress]),(0,n.useEffect)((()=>{(async()=>{t?.cartTotal?.value&&(S(!0),f().then((e=>{k(e.revolut_order_public_id),C(e.revolut_order_amount),S(!1)})).catch((e=>T(p(e.message||"An unexpected error occurred"),{id:"create_order_failed",context:a.noticeContexts.PAYMENTS}))))})()}),[t.cartTotal.value]);const O=(({onMsg:e,publicId:t},r)=>{const s=(0,n.useRef)(e),a=(0,n.useRef)(null),o=(0,n.useRef)(null);return(0,n.useEffect)((()=>{let e=!1;return o.current&&(o.current.destroy(),s.current({type:"instance_destroyed"})),RevolutCheckout(t).then((t=>{!e&&a.current&&(o.current=t.createCardField({locale:c.locale,target:a.current,hidePostcodeField:!0,onSuccess(){s.current({type:"payment_successful"})},onError(e){L.includes(e.type)?s.current({type:"fields_errors_changed",errors:[e]}):s.current({type:"payment_failed",error:e})},onValidation:e=>s.current({type:"fields_errors_changed",errors:e}),onStatusChange:e=>{s.current({type:"fields_status_changed",status:e})},onCancel(){s.current({type:"payment_cancelled"})}}),s.current({type:"instance_mounted",instance:o.current}))})),()=>{e=!0,o.current&&(o.current.destroy(),o.current=null,s.current({type:"instance_destroyed"}))}}),[t,s,...r]),a})({publicId:x,onMsg:e=>{switch(e.type){case"payment_successful":document.dispatchEvent(new Event("payment_successful"));break;case"payment_failed":document.dispatchEvent(new CustomEvent("payment_failed",{detail:e.error.toString()}));break;case"instance_destroyed":_.current=null;break;case"instance_mounted":_.current=e.instance;break;case"fields_errors_changed":w(e.errors);break;case"fields_status_changed":g(e.status)}}},[P]),M=async()=>{j();let e=null;return t?.billingAddress||(e="Please check your billing address, and retry again."),(!v.completed||b.length>0)&&(e="The payment form is not ready for submission.",_.current&&(_.current.validate(),e="The payment form is not ready for submission. please fix the errors below and retry again.")),u.card_holder_name_field_enabled&&(y.current.isComplete()||(e="The payment form is not ready for submission. please fix the errors below and retry again.")),e?{type:a.responseTypes.ERROR,message:p(e),retry:!0,messageContext:a.noticeContexts.PAYMENTS}:{type:a.responseTypes.SUCCESS}},N=async e=>{S(!0);const{billingAddress:n}=t,{shippingAddress:o}=r,c={name:u.card_holder_name_field_enabled&&y.current.value.length>0?y.current.value:`${n.first_name} ${n.last_name}`,email:n.email,phone:n.phone,savePaymentMethodFor:s||u.is_save_payment_method_mandatory?"merchant":""};void 0!==n.country&&void 0!==n.postcode&&(c.billingAddress=h(n),c.shippingAddress=h(n)),o&&void 0!==o.country&&void 0!==o.postcode&&(c.shippingAddress=h(o));const i=await D({paymentData:c});if(!i.success)return i.error?(S(!1),{type:a.responseTypes.ERROR,message:p(i.error||"Unexpected error occurred, please try again later"),retry:!0,messageContext:a.noticeContexts.PAYMENTS}):void S(!1);E({response:e,paymentMethod:A.REVOLUT_CARD,shouldSavePayment:s})},D=async({paymentData:e})=>(_.current.submit(e),new Promise(((e,t)=>{document.addEventListener("payment_successful",(()=>{e({success:!0})})),document.addEventListener("payment_failed",(t=>{e({success:!1,error:t.detail})}))})));return(0,n.useEffect)((()=>{O.current&&(b.length>0?O.current.classList.add("woocommerce-revolut-card-element-error"):O.current.classList.remove("woocommerce-revolut-card-element-error"))}),[b]),(0,I.jsx)(I.Fragment,{children:(0,I.jsx)(i.LoadingMask,{showSpinner:!0,isLoading:l.isProcessing||l.isComplete||R,children:x&&(0,I.jsxs)(I.Fragment,{children:[(0,I.jsxs)("div",{children:[(0,I.jsx)("div",{id:"woocommerce-revolut-card-element",ref:O}),b.length>0&&(0,I.jsx)(V,{errorList:b})]}),u.card_holder_name_field_enabled&&(0,I.jsx)("div",{style:{marginTop:10},children:(0,I.jsx)(q,{inputRef:y})}),u.banner.upsell_banner_enabled&&(0,I.jsx)("div",{children:(0,I.jsx)(G,{orderToken:x})})]})})})},$={name:A.REVOLUT_CARD,label:(0,I.jsx)(U,{settings:u}),content:(0,I.jsx)(K,{settings:u}),edit:(0,I.jsx)("p",{children:p("Revolut Gateway is not available in editor mode")}),ariaLabel:p("Revolut Card`s Gateway"),canMakePayment:()=>u.can_make_payment,supports:{features:["products","subscriptions"],showSavedCards:!0,showSaveOption:!u.is_save_payment_method_mandatory}},H=()=>((0,n.useEffect)((()=>{P()}),[]),(0,I.jsx)("div",{id:j})),X=i.can_make_payment&&i.banner.points_banner_enabled,W={metadata:{name:"revolut-gateway-for-woocommerce/revolut-banner",category:"woocommerce",parent:[e.innerBlockAreas.CHECKOUT_ORDER_SUMMARY],attributes:{lock:{type:"object",default:{remove:!0,move:!0}}}},force:!0,component:()=>X?(0,I.jsx)(H,{}):""},z=({billing:e,components:t,checkoutStatus:r,eventRegistration:s,emitResponse:a,onSubmit:c})=>{const{onCheckoutSuccess:i,onCheckoutFail:l}=s,{VALIDATION_STORE_KEY:u}=window.wc.wcBlocksData,[d,p]=(0,n.useState)(!1),m=(0,n.useRef)(null),_=(0,n.useRef)(null),y=(0,n.useRef)(null),{revolutPrbRef:h}=M({paymentOptions:{amount:e.cartTotal.value,requestPayerInfo:{billingAddress:!1},validate:()=>new Promise(((e,t)=>{p(!0),(0,o.select)(u).hasValidationErrors()&&(p(!1),t("Checkout form is incomplete")),f().then((r=>{m.current=r.revolut_order_public_id,c(),document.addEventListener("checkout_success",(()=>{e(!0)})),document.addEventListener("checkout_fail",(()=>{p(!1),t("Something went wrong")}))}))})),createOrder:()=>({publicId:m.current})},onSuccess:()=>{p(!0),E({response:_.current,paymentMethod:A.REVOLUT_PRB,shouldSavePayment:0})},onError:e=>{p(!1),y.current&&y.current.resolve((e=>({type:a.responseTypes.ERROR,message:e,retry:!0,messageContext:a.noticeContexts.PAYMENTS}))(e))}},[e.cartTotal.value]);return(0,n.useEffect)((()=>{const e=i((async e=>new Promise((t=>{p(!1),_.current=e,document.dispatchEvent(new CustomEvent("checkout_success")),y.current={resolve:t}})))),t=l((e=>{e&&e.paymentDetails&&e.paymentDetails.wc_order_id||document.dispatchEvent(new CustomEvent("checkout_fail"))}));return()=>{e(),t()}}),[i,l]),N(),(0,I.jsxs)(I.Fragment,{children:[" ",(0,I.jsx)(t.LoadingMask,{showSpinner:!0,isLoading:d||r.isProcessing||r.isComplete,children:(0,I.jsx)("div",{ref:h})})]})},J=({billing:e,setExpressPaymentError:t,eventRegistration:r,onSubmit:s,onClick:a,onClose:o,emitResponse:i})=>{const{onPaymentSetup:l,onCheckoutFail:u}=r,d=(0,n.useRef)(),p=(0,n.useRef)(),{revolutPrbRef:_,destroyRef:h}=M({paymentOptions:{amount:0,requestShipping:!0,validate:()=>(a(),!0),onShippingOptionChange:e=>function(e){let t={security:c.fast_checkout_params.nonce.update_shipping,shipping_method:[e.id],is_product_page:c.fast_checkout_params.is_product_page};return new Promise(((e,r)=>{y({data:t,endpoint:m({endpoint:O.UPDATE_SHIPPING_METHOD})}).then((t=>{e(t)})).catch((e=>{r(e)}))}))}(e),onShippingAddressChange:e=>function(e){let t={security:c.fast_checkout_params.nonce.shipping,country:e.country,state:e.region,postcode:e.postalCode,city:e.city,address:"",address_2:"",is_product_page:c.fast_checkout_params.is_product_page,require_shipping:c.fast_checkout_params.shipping_required};return new Promise(((e,r)=>{y({data:t,endpoint:m({endpoint:O.GET_SHIPPING_OPTIONS})}).then((t=>{e(t)})).catch((e=>{r(e)}))}))}(e),createOrder:()=>new Promise(((e,t)=>{g().then((t=>{p.current=t,e({publicId:t})})).catch((e=>{t(e)}))})),validate(e){d.current=e}},onSuccess:()=>R({onSubmit:s,address:d.current}).catch((e=>{h.current(),b(p.current),t(e)})),onError:e=>{t(e||"Something went wrong while completing your payment"),o()},onCancel:e=>{t(e),o()}},[e.cartTotal.value]);return(0,n.useEffect)((()=>{const e=l((()=>({type:i.responseTypes.SUCCESS,meta:{paymentMethodData:{is_express_checkout:1}}}))),r=u((()=>{w(p.current).then((e=>{t(e.message),"failure"===e.type&&h.current()}))}));return()=>{e(),r()}}),[l,u]),(0,I.jsxs)(I.Fragment,{children:[" ",(0,I.jsx)("div",{ref:_})]})},Q={name:"revolut_payment_request",label:(0,I.jsx)(U,{settings:d}),content:(0,I.jsx)(z,{}),edit:(0,I.jsx)("p",{children:p("Google/Apple Pay block is not available in editor mode")}),ariaLabel:"Google Pay/Apple Pay",canMakePayment:()=>d.can_make_payment,paymentMethodId:"revolut_payment_request",supports:{features:["products"]}},Z={...Q,name:"revolut_payment_request_express_checkout",paymentMethodId:"revolut_payment_request",content:(0,I.jsx)(J,{}),canMakePayment:()=>d.can_make_payment&&d.is_cart},ee=({billing:e,components:t,eventRegistration:r,onSubmit:s,emitResponse:a})=>{const{onCheckoutSuccess:c,onCheckoutFail:i}=r,{VALIDATION_STORE_KEY:l}=window.wc.wcBlocksData,[u,d]=(0,n.useState)(!1),[p,m]=(0,n.useState)(!1),_=(0,n.useRef)(null),y=(0,n.useRef)(null),h=(0,n.useRef)(null),v=e=>({type:a.responseTypes.ERROR,message:e,retry:!0,messageContext:a.noticeContexts.PAYMENTS}),g={totalAmount:e.cartTotal.value,validate:()=>(m(!1),new Promise((e=>{d(!0),(0,o.select)(l).hasValidationErrors()&&(d(!1),e(!1)),f().then((t=>{_.current=t.revolut_order_public_id,s(),document.addEventListener("checkout_success",(()=>{e(!0)})),document.addEventListener("checkout_fail",(()=>{d(!1),e(!1)}))}))}))),createOrder:()=>({publicId:_.current})},{revolutPayRef:b}=D({paymentOptions:g,onSuccess:()=>{d(!0),E({response:y.current,paymentMethod:A.REVOLUT_PAY,shouldSavePayment:0})},onError:e=>{d(!1),h.current&&h.current.resolve(v(e))},onCancel:()=>{m(!0),h.current&&h.current.resolve(v("Payment cancelled!"))}},[e.cartTotal.value]);return(0,n.useEffect)((()=>{const e=c((async e=>new Promise((t=>{if(p)return d(!1),t(v("Payment cancelled!"));d(!1),y.current=e,document.dispatchEvent(new CustomEvent("checkout_success")),h.current={resolve:t}})))),t=i((e=>{e&&e.paymentDetails&&e.paymentDetails.wc_order_id||document.dispatchEvent(new CustomEvent("checkout_fail"))}));return()=>{e(),t()}}),[c,i,p]),N(),(0,I.jsxs)(I.Fragment,{children:[" ",(0,I.jsx)(t.LoadingMask,{showSpinner:!0,isLoading:u,children:(0,I.jsx)("div",{ref:b})})]})},te=({billing:e,setExpressPaymentError:t,eventRegistration:r,onSubmit:s,onClick:a,onClose:o,emitResponse:i})=>{const{onPaymentSetup:l,onCheckoutFail:u}=r,d=(0,n.useRef)(),p={requestShipping:!0,validate:()=>(a(),!0),createOrder:()=>g().then((e=>(d.current=e,(e=>y({data:{revolut_public_id:e,security:c.fast_checkout_params.nonce.update_order_total},endpoint:m({endpoint:O.UPDATE_PAYMENT_TOTAL})}))(e).then((()=>({publicId:e}))))))},{revolutPayRef:_,destroyRef:h}=D({paymentOptions:p,onSuccess:e=>(async e=>{try{const t=await y({data:{security:c.fast_checkout_params.nonce.load_order_data,revolut_public_id:e},endpoint:m({endpoint:O.LOAD_ORDER_DATA})});if(t)return t;throw new Error("Something went wrong while retrieving the billing address. your payment will be cancelled")}catch(e){throw new Error(e.message||"An unexpected error occurred.")}})(e).then((r=>{R({onSubmit:s,address:r.address_info}).catch((r=>{h.current(),b(e),t(r)}))})).catch((r=>{b(e),t(r)})),onError:e=>{t(e||"Something went wrong while completing your payment"),o()},onCancel:e=>{t(e||"Payment cancelled!"),o()}},[e.cartTotal.value]);return(0,n.useEffect)((()=>{const e=l((()=>({type:i.responseTypes.SUCCESS,meta:{paymentMethodData:{is_express_checkout:1}}}))),r=u((()=>{w(d.current).then((e=>{t(e.message),"failure"===e.type&&h.current()}))}));return()=>{e(),r()}}),[l,u]),(0,n.useEffect)((()=>{P()}),[]),(0,I.jsxs)(I.Fragment,{children:[" ",(0,I.jsx)("div",{id:j}),(0,I.jsx)("div",{ref:_})]})},re=new URLSearchParams(window.location.search),ne=re.get("_rp_fr"),se=re.get("_rp_oid"),ae=re.get("_rp_s");(ne||!ae&&se)&&((0,o.dispatch)("core/notices").createErrorNotice(p(ne||"Payment Rejected"),{id:"rp-fr",context:"wc/checkout/payments"}),i.is_cart||(0,o.dispatch)(T).__internalSetActivePaymentMethod(A.REVOLUT_PAY));const oe={name:"revolut_pay",label:(0,I.jsx)(Y,{}),content:(0,I.jsx)(ee,{}),edit:(0,I.jsx)("p",{children:p("Revolut Pay is not available in editor mode")}),ariaLabel:"Revolut Pay",canMakePayment:()=>i.can_make_payment,paymentMethodId:"revolut_pay",supports:{features:["products"]}},ce={...oe,name:"revolut_pay_express_checkout",paymentMethodId:"revolut_pay",content:(0,I.jsx)(te,{settings:i}),canMakePayment:()=>i.can_make_payment&&i.is_cart},ie=({eventRegistration:e,billing:t,emitResponse:r})=>{const{onPaymentSetup:s,onCheckoutSuccess:a}=e,i=(0,n.useRef)(null),[l,u]=(0,n.useState)(""),{createErrorNotice:d,removeAllNotices:m}=(0,o.dispatch)("core/notices"),_=async()=>{m();let e=null;try{let e=await f();u(e.revolut_order_public_id)}catch({name:t,message:r}){e=r}return e?{type:r.responseTypes.ERROR,message:p(e),retry:!0,messageContext:r.noticeContexts.PAYMENTS}:{type:r.responseTypes.SUCCESS}};return(0,n.useEffect)((()=>{const e=s(_),t=a((e=>new Promise((async(t,n)=>{let s;try{s=await f()}catch({name:e,message:n}){return void t({type:r.responseTypes.ERROR,message:p("Payment cancelled!"),retry:!0,messageContext:r.noticeContexts.PAYMENTS})}const{payByBank:a}=await RevolutCheckout.payments({publicToken:c.merchant_public_key,locale:c.locale});i.current=a({createOrder:()=>Promise.resolve({publicId:s.revolut_order_public_id}),onError:e=>{t({type:r.responseTypes.ERROR,message:p(e||"Unexpected error occurred, please try again later"),retry:!0,messageContext:r.noticeContexts.PAYMENTS})},onSuccess:()=>{E({response:e,paymentMethod:A.REVOLUT_PAY_BY_BANK,shouldSavePayment:0})},onCancel:()=>{t({type:r.responseTypes.ERROR,message:p("Payment cancelled!"),retry:!0,messageContext:r.noticeContexts.PAYMENTS})}}),i.current.show()}))));return()=>{i.current&&i.current.destroy(),t(),e()}}),[a]),(0,I.jsx)(I.Fragment,{})},le={name:A.REVOLUT_PAY_BY_BANK,label:(0,I.jsx)(B,{settings:l}),content:(0,I.jsx)(ie,{settings:l}),edit:(0,I.jsx)("p",{children:p("Revolut Pay By Bank Gateway is not available in editor mode")}),ariaLabel:p("Revolut Pay By Bank Gateway"),canMakePayment:()=>l.can_make_payment};(0,t.registerPaymentMethod)($),(0,t.registerPaymentMethod)(le),(0,t.registerExpressPaymentMethod)(ce),(0,t.registerPaymentMethod)(oe),(0,e.registerCheckoutBlock)(W),(0,t.registerExpressPaymentMethod)(Z),(0,t.registerPaymentMethod)(Q)})()})();