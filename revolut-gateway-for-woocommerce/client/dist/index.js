(()=>{"use strict";const e=window.wc.wcSettings,t=window.wp.i18n,r=window.wp.data,n=t=>(0,e.getSetting)(`${t}_data`),a=e=>(0,t.__)(e,"revolut-gateway-for-woocommerce"),{CART_STORE_KEY:o}=window.wc.wcBlocksData,s=(e,t="revolut_payment_request_")=>wc_revolut_payment_request_params.ajax_url.toString().replace("%%wc_revolut_gateway_ajax_endpoint%%",`${t}${e}`);function c(e,t,r){const n=e;if(t&&"object"==typeof t)Object.keys(t).forEach((e=>{c(n,t[e],r?`${r}[${e}]`:e)}));else{const e=null==t?"":t;n.append(r,e)}return n}const u=async({data:e,endpoint:t})=>{const r=c(new FormData,e),n=await fetch(t,{method:"POST",body:r});if(!n.ok)throw new Error("Failed to process your request due to network issue");return await n.json()},l=e=>({countryCode:e.country,region:e.state,city:e.city,streetLine1:e.address_1,streetLine2:e.address_2,postcode:e.postcode}),i="revolut_cc",d="revolut_pay",p="revolut_payment_request",m="undefined"!=typeof wc_revolut_payment_request_params&&wc_revolut_payment_request_params.is_cart_page,_=async()=>{if("undefined"==typeof wc_revolut_payment_request_params)return Promise.reject(new Error("Unexpected error occurred"));const e=await u({endpoint:s("get_express_checkout_params"),data:{security:wc_revolut_payment_request_params.nonce.get_express_checkout_params}});return e?.success?(wc_revolut_payment_request_params.revolut_public_id=e.revolut_public_id,e.revolut_public_id):Promise.reject(new Error("Something went wrong while creating the payment."))},y=async e=>{const t=await u({endpoint:e.create_revolut_order_endpoint,data:{security:e.create_revolut_order_nonce}});if(t?.success)return t;throw new Error("An unexpected error occurred")},h=async()=>(await u({data:{revolut_public_id:wc_revolut_payment_request_params.revolut_public_id,security:wc_revolut_payment_request_params.nonce.cancel_order},endpoint:s("cancel_order")})).success,v=async()=>{try{if(await h())return{type:"error",message:a("Something went wrong, your order has been cancelled.")};throw new Error("Couldn`t cancel the order")}catch(e){return{type:"failure",message:a("Your order has been completed, but we couldn't redirect you to the confirmation page. Please contact us for assistance.")}}},w=async({response:e,paymentMethod:t,shouldSavePayment:r})=>{try{const{processingResponse:a}=e,{wc_order_id:o,revolut_public_id:s,process_payment_result:c}=a.paymentDetails,l=await(async({process_payment_result:e,revolut_public_id:t,shouldSavePayment:r,wc_order_id:a,paymentMethod:o})=>{try{const s=n(o),c={revolut_gateway:o,security:e,revolut_public_id:t,revolut_payment_error:"",wc_order_id:a,reload_checkout:0,revolut_save_payment_method:Number(r)||Number(s.is_save_payment_method_mandatory)},l=await u({data:c,endpoint:s.process_order_endpoint});if("fail"===l?.result)throw new Error(l?.messages||"Something went wrong while trying to charge your card, please try again");if("success"===l?.result)return l;throw new Error("Failed to process your order due to server issue")}catch(e){throw new Error(e.message||"An unexpected error occurred")}})({wc_order_id:o,revolut_public_id:s,process_payment_result:c,shouldSavePayment:r,paymentMethod:t});if(l.redirect)return window.location.href=decodeURI(l.redirect),{type:"success"};throw new Error("Could not redirect you to the confirmation page due to an unexpected error. Please contact the merchant")}catch(e){return{type:"error",message:a(e?.message),retry:!0,messageContext:"wc/checkout/payments"}}},g=async({onSubmit:e})=>new Promise(((t,n)=>(async()=>{try{const e=await u({data:{security:wc_revolut_payment_request_params.nonce.load_order_data,revolut_public_id:wc_revolut_payment_request_params.revolut_public_id},endpoint:s("load_order_data")});if(e)return e;throw new Error("Something went wrong while retrieving the billing address. your payment will be cancelled")}catch(e){throw new Error(e.message||"An unexpected error occurred.")}})().then((n=>{const{billingAddress:a,shippingAddress:s}=n.address_info;let c=a.recipient.indexOf(" "),u=a.recipient.substring(0,c),l=a.recipient.substring(c+1);(0,r.dispatch)(o).setBillingAddress({first_name:u,last_name:l,address_1:a.address,address_2:a.address_2,city:a.city,state:a.state,postcode:a.postcode,country:a.country,email:n.address_info.email,phone:a.phone}),(0,r.dispatch)(o).setShippingAddress({first_name:u,last_name:l,address_1:s.address,address_2:s.address_2,city:s.city,state:s.state,postcode:s.postcode,country:s.country,phone:s.phone}),e(),t(!0)})).catch((e=>n(e))))),f=window.React,E=window.wp.element,b=["error.3ds-failed","error.email-is-not-specified","error.invalid-postcode","error.invalid-email","error.incorrect-cvv-code","error.expired-card","error.do-not-honour","error.insufficient-funds"],S=({paymentOptions:e,onSuccess:t,onError:r},a)=>{const o=(0,E.useRef)(null),s=(0,E.useRef)(),c=n(p);return(0,E.useEffect)((()=>((async()=>{const{paymentRequest:n,destroy:a}=await RevolutCheckout.payments({publicToken:c.merchant_public_key,locale:c.locale});if(s.current=a,o.current){const a=n.mount(o.current,{...e,onSuccess(){t()},onError(e){r(e.message)},onCancel(){r("Payment cancelled!")}});a.canMakePayment().then((e=>{e?a.render():a.destroy()}))}})(),()=>s.current())),a),{revolutPrbRef:o,destroyRef:s}},R=()=>{(0,E.useEffect)((()=>{const e=document.querySelector(".wp-element-button.wc-block-components-checkout-place-order-button");return e&&(e.disabled=!0,e.style.display="none"),()=>{e&&(e.disabled=!1,e.style.display="block")}}),[])},k=({paymentOptions:e,onSuccess:t,onError:r,onCancel:a},o)=>{const s=(0,E.useRef)(null),c=(0,E.useRef)(),u=n(d);return(0,E.useEffect)((()=>((async()=>{const{revolutPay:n,destroy:o}=await RevolutCheckout.payments({publicToken:u.merchant_public_key,locale:u.locale});c.current=o,s.current&&n.mount(s.current,e),n.on("payment",(e=>{switch(e.type){case"cancel":a();break;case"success":t();break;case"error":r(e.error.message)}}))})(),()=>{c.current()})),o),{revolutPayRef:s,destroyRef:c}},P=({settings:e})=>{const{available_card_brands:t,wc_revolut_plugin_url:r,title:n}=e;return(0,f.createElement)("div",{className:"revolut-card-label-container"},(0,f.createElement)("strong",null,n),(0,f.createElement)("div",{className:"revolut-card-label-brands"},t&&t.filter((e=>"maestro"!==e)).map((e=>(0,f.createElement)("img",{key:e,src:`${r}/assets/images/${e}.svg`,style:{marginLeft:2},alt:e})))))},C=({inputRef:e})=>{const[t,r]=(0,E.useState)([]),n=(0,E.useRef)(!1),a=()=>{const t=2===e.current.value.trim().split(/\s+/).length;return!t&&n.current?(e.current.classList.add("wc-revolut-cardholder-name-error"),r([{message:"Please provide your full name"}])):(e.current.classList.remove("wc-revolut-cardholder-name-error"),r([])),t};return e.current&&(e.current.isComplete=()=>(n.current=!0,a())),(0,f.createElement)("div",{className:"form-row form-row-first validate-required",id:"cardholder-name","data-priority":"10",style:{display:"block",width:"100%",marginBottom:15}},(0,f.createElement)("input",{ref:e,type:"text",onChange:a,className:"input-text",name:"wc-revolut-cardholder-name",id:"wc-revolut-cardholder-name",placeholder:"Cardholder name",autoComplete:"cardholder",required:!0}),(0,f.createElement)("div",{style:{marginBottom:10,marginTop:10}},(0,f.createElement)(q,{errorList:t})))},q=({errorList:e})=>(0,f.createElement)("div",null,e.map(((e,t)=>(0,f.createElement)("li",{className:"card-field-error",key:t},e.message)))),T=({revolutPublicId:e})=>{const t=n(i);return(0,E.useEffect)((()=>{RevolutUpsell({locale:t.locale,mode:t.mode,publicToken:t.merchantPublicKey}).cardGatewayBanner.mount(document.getElementById("revolut-upsell-banner"),{orderToken:e})}),[e]),(0,f.createElement)("div",{id:"revolut-upsell-banner"})},x=n(i),A={name:i,label:(0,f.createElement)(P,{settings:x}),content:(0,f.createElement)((({eventRegistration:e,billing:t,shippingData:o,shouldSavePayment:s,emitResponse:c,components:u,checkoutStatus:d})=>{const p=i,{onPaymentSetup:m,onCheckoutSuccess:_}=e,h=n(p),v=(0,E.useRef)(),g=(0,E.useRef)(),[S,R]=(0,E.useState)(!1),[k,P]=(0,E.useState)([]),[x,A]=(0,E.useState)(!1),[M,L]=(0,E.useState)(""),[O,N]=(0,E.useState)(0),{createErrorNotice:D,removeAllNotices:I}=(0,r.dispatch)("core/notices");(0,E.useEffect)((()=>{const e=m(Y),t=_(B);return()=>{e(),t()}}),[_,m,k,S,s,t.billingAddress,o.shippingAddress]),(0,E.useEffect)((()=>{(async()=>{t?.cartTotal?.value&&(A(!0),y(h).then((e=>{L(e.revolut_order_public_id),N(e.revolut_order_amount),A(!1)})).catch((e=>D(a(e.message||"An unexpected error occurred"),{id:"create_order_failed",context:c.noticeContexts.PAYMENTS}))))})()}),[t.cartTotal.value]);const F=(({onMsg:e,publicId:t,locale:r},n)=>{const a=(0,E.useRef)(e),o=(0,E.useRef)(null),s=(0,E.useRef)(null);return(0,E.useEffect)((()=>{let e=!1;return s.current&&(s.current.destroy(),a.current({type:"instance_destroyed"})),RevolutCheckout(t).then((t=>{!e&&o.current&&(s.current=t.createCardField({locale:r,target:o.current,onSuccess(){a.current({type:"payment_successful"})},onError(e){b.includes(e.type)?a.current({type:"fields_errors_changed",errors:[e]}):a.current({type:"payment_failed",error:e})},onValidation:e=>a.current({type:"fields_errors_changed",errors:e}),onStatusChange:e=>{a.current({type:"fields_status_changed",status:e})},onCancel(){a.current({type:"payment_cancelled"})}}),a.current({type:"instance_mounted",instance:s.current}))})),()=>{e=!0,s.current&&(s.current.destroy(),s.current=null,a.current({type:"instance_destroyed"}))}}),[t,a,r,...n]),o})({publicId:M,locale:h.locale,onMsg:e=>{switch(e.type){case"payment_successful":document.dispatchEvent(new Event("payment_successful"));break;case"payment_failed":document.dispatchEvent(new CustomEvent("payment_failed",{detail:e.error.toString()}));break;case"instance_destroyed":v.current=null;break;case"instance_mounted":v.current=e.instance;break;case"fields_errors_changed":P(e.errors);break;case"fields_status_changed":R(e.status)}}},[O]),Y=async()=>{I();let e=null;return t?.billingAddress||(e="Please check your billing address, and retry again."),(!S.completed||k.length>0)&&(e="The payment form is not ready for submission.",v.current&&(v.current.validate(),e="The payment form is not ready for submission. please fix the errors below and retry again.")),h.card_holder_name_field_enabled&&(g.current.isComplete()||(e="The payment form is not ready for submission. please fix the errors below and retry again.")),e?{type:c.responseTypes.ERROR,message:a(e),retry:!0,messageContext:c.noticeContexts.PAYMENTS}:{type:c.responseTypes.SUCCESS}},B=async e=>{A(!0);const{billingAddress:r}=t,{shippingAddress:n}=o,u={name:h.card_holder_name_field_enabled&&g.current.value.length>0?g.current.value:`${r.first_name} ${r.last_name}`,email:r.email,phone:r.phone,savePaymentMethodFor:s||h.is_save_payment_method_mandatory?"merchant":""};void 0!==r.country&&void 0!==r.postcode&&(u.billingAddress=l(r),u.shippingAddress=l(r)),n&&void 0!==n.country&&void 0!==n.postcode&&(u.shippingAddress=l(n));const d=await U({paymentData:u});if(!d.success)return d.error?(A(!1),{type:c.responseTypes.ERROR,message:a(d.error||"Unexpected error occurred, please try again later"),retry:!0,messageContext:c.noticeContexts.PAYMENTS}):void A(!1);w({response:e,paymentMethod:i,shouldSavePayment:s})},U=async({paymentData:e})=>(v.current.submit(e),new Promise(((e,t)=>{document.addEventListener("payment_successful",(()=>{e({success:!0})})),document.addEventListener("payment_failed",(t=>{e({success:!1,error:t.detail})}))})));return(0,E.useEffect)((()=>{F.current&&(k.length>0?F.current.classList.add("woocommerce-revolut-card-element-error"):F.current.classList.remove("woocommerce-revolut-card-element-error"))}),[k]),(0,f.createElement)(f.Fragment,null,(0,f.createElement)(u.LoadingMask,{showSpinner:!0,isLoading:d.isProcessing||d.isComplete||x},M&&(0,f.createElement)(f.Fragment,null,(0,f.createElement)("div",null,(0,f.createElement)("div",{id:"woocommerce-revolut-card-element",ref:F}),k.length>0&&(0,f.createElement)(q,{errorList:k})),h.card_holder_name_field_enabled&&(0,f.createElement)("div",{style:{marginTop:10}},(0,f.createElement)(C,{inputRef:g})),h.promotional_banner_enabled&&(0,f.createElement)("div",null,(0,f.createElement)(T,{revolutPublicId:M})))))}),null),edit:(0,f.createElement)("p",null,a("Revolut Gateway is not available in editor mode")),ariaLabel:a("Revolut Card`s Gateway"),canMakePayment:()=>x.can_make_payment,supports:{features:["products"],showSavedCards:!0,showSaveOption:!x.is_save_payment_method_mandatory}},{PAYMENT_STORE_KEY:M}=window.wc.wcBlocksData,L=n(d),O=new URLSearchParams(window.location.search),N=O.get("_rp_fr"),D=O.get("_rp_oid"),I=O.get("_rp_s");(N||!I&&D)&&((0,r.dispatch)("core/notices").createErrorNotice(a(N||"Payment Rejected"),{id:"rp-fr",context:"wc/checkout/payments"}),m||(0,r.dispatch)(M).__internalSetActivePaymentMethod(d));const F={name:"revolut_pay",label:(0,f.createElement)(P,{settings:L}),content:m?(0,f.createElement)((({billing:e,setExpressPaymentError:t,eventRegistration:r,onSubmit:a,onClick:o,onClose:s,emitResponse:c})=>{const{onPaymentSetup:u,onCheckoutFail:l}=r,i=n(d),p={currency:i.order_currency,totalAmount:0,mobileRedirectUrls:{success:i.mobile_redirect_url,failure:i.mobile_redirect_url,cancel:i.mobile_redirect_url},buttonStyle:{cashbackCurrency:wc_revolut_payment_request_params.currency,variant:wc_revolut_payment_request_params.revolut_pay_button_theme,size:wc_revolut_payment_request_params.revolut_pay_button_size,radius:wc_revolut_payment_request_params.revolut_pay_button_radius},requestShipping:!0,validate:()=>(o(),!0),createOrder:()=>new Promise(((e,t)=>{_().then((t=>{e({publicId:t})})).catch((e=>{t(e)}))}))},{revolutPayRef:m,destroyRef:y}=k({paymentOptions:p,onSuccess:()=>g({onSubmit:a}).catch((e=>{y.current(),h(),t(e)})),onError:e=>{t(e||"Something went wrong while completing your payment"),s()},onCancel:e=>{t(e||"Payment cancelled!"),s()}},[e.cartTotal.value]);return(0,E.useEffect)((()=>{const e=u((()=>({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{is_express_checkout:1}}}))),r=l((()=>{v().then((e=>{t(e.message),"failure"===e.type&&y.current()}))}));return()=>{e(),r()}}),[u,l]),(0,f.createElement)(f.Fragment,null," ",(0,f.createElement)("div",{ref:m}))}),null):(0,f.createElement)((({billing:e,components:t,eventRegistration:a,onSubmit:o,emitResponse:s})=>{const{onCheckoutSuccess:c,onCheckoutFail:u}=a,{VALIDATION_STORE_KEY:l}=window.wc.wcBlocksData,i=n(d),[p,m]=(0,E.useState)(!1),[_,h]=(0,E.useState)(!1),v=(0,E.useRef)(null),g=(0,E.useRef)(null),b=(0,E.useRef)(null),S=e=>({type:s.responseTypes.ERROR,message:e,retry:!0,messageContext:s.noticeContexts.PAYMENTS}),P={currency:i.order_currency,totalAmount:e.cartTotal.value,mobileRedirectUrls:{success:i.mobile_redirect_url,failure:i.mobile_redirect_url,cancel:i.mobile_redirect_url},validate:()=>(h(!1),new Promise((e=>{m(!0),(0,r.select)(l).hasValidationErrors()&&(m(!1),e(!1)),y(i).then((t=>{v.current=t.revolut_order_public_id,o(),document.addEventListener("checkout_success",(()=>{e(!0)})),document.addEventListener("checkout_fail",(()=>{m(!1),e(!1)}))}))}))),createOrder:()=>({publicId:v.current})},{revolutPayRef:C}=k({paymentOptions:P,onSuccess:()=>{m(!0),w({response:g.current,paymentMethod:d,shouldSavePayment:0})},onError:e=>{m(!1),b.current&&b.current.resolve(S(e))},onCancel:()=>{h(!0),b.current&&b.current.resolve(S("Payment cancelled!"))}},[e.cartTotal.value]);return(0,E.useEffect)((()=>{const e=c((async e=>new Promise((t=>{if(_)return m(!1),t(S("Payment cancelled!"));m(!1),g.current=e,document.dispatchEvent(new CustomEvent("checkout_success")),b.current={resolve:t}})))),t=u((e=>{e&&e.paymentDetails&&e.paymentDetails.wc_order_id||document.dispatchEvent(new CustomEvent("checkout_fail"))}));return()=>{e(),t()}}),[c,u,_]),R(),(0,f.createElement)(f.Fragment,null," ",(0,f.createElement)(t.LoadingMask,{showSpinner:!0,isLoading:p},(0,f.createElement)("div",{ref:C})))}),null),edit:(0,f.createElement)("p",null,a("Revolut Pay is not available in editor mode")),ariaLabel:"Revolut Pay",canMakePayment:()=>L.can_make_payment,paymentMethodId:"revolut_pay",supports:{features:["products"]}},Y=F,B=n(p),U={name:"revolut_payment_request",label:(0,f.createElement)(P,{settings:B}),content:m?(0,f.createElement)((({billing:e,setExpressPaymentError:t,eventRegistration:r,onSubmit:a,onClick:o,onClose:c,emitResponse:l})=>{const{onPaymentSetup:i,onCheckoutFail:d}=r,m=n(p),{revolutPrbRef:y,destroyRef:w}=S({paymentOptions:{currency:m.order_currency,amount:0,requestShipping:!0,shippingOptions:wc_revolut_payment_request_params.free_shipping_option,validate:()=>(o(),!0),onShippingOptionChange:e=>function(e){let t={security:wc_revolut_payment_request_params.nonce.update_shipping,shipping_method:[e.id],is_product_page:wc_revolut_payment_request_params.is_product_page};return new Promise(((e,r)=>{u({data:t,endpoint:s("update_shipping_method")}).then((t=>{e(t)})).catch((e=>{r(e)}))}))}(e),onShippingAddressChange:e=>function(e){let t={security:wc_revolut_payment_request_params.nonce.shipping,country:e.country,state:e.region,postcode:e.postalCode,city:e.city,address:"",address_2:"",is_product_page:wc_revolut_payment_request_params.is_product_page,require_shipping:wc_revolut_payment_request_params.shipping_required};return new Promise(((e,r)=>{u({data:t,endpoint:s("get_shipping_options")}).then((t=>{e(t)})).catch((e=>{r(e)}))}))}(e),createOrder:()=>new Promise(((e,t)=>{_().then((t=>{e({publicId:t})})).catch((e=>{t(e)}))})),buttonStyle:{action:wc_revolut_payment_request_params.payment_request_button_type,size:wc_revolut_payment_request_params.payment_request_button_size,variant:wc_revolut_payment_request_params.payment_request_button_theme,radius:wc_revolut_payment_request_params.payment_request_button_radius}},onSuccess:()=>g({onSubmit:a}).catch((e=>{w.current(),h(),t(e)})),onError:e=>{t(e||"Something went wrong while completing your payment"),c()},onCancel:e=>{t(e),c()}},[e.cartTotal.value]);return(0,E.useEffect)((()=>{const e=i((()=>({type:l.responseTypes.SUCCESS,meta:{paymentMethodData:{is_express_checkout:1}}}))),r=d((()=>{v().then((e=>{t(e.message),"failure"===e.type&&w.current()}))}));return()=>{e(),r()}}),[i,d]),(0,f.createElement)(f.Fragment,null," ",(0,f.createElement)("div",{ref:y}))}),null):(0,f.createElement)((({billing:e,components:t,checkoutStatus:a,eventRegistration:o,emitResponse:s,onSubmit:c})=>{const{onCheckoutSuccess:u,onCheckoutFail:l}=o,{VALIDATION_STORE_KEY:i}=window.wc.wcBlocksData,[d,m]=(0,E.useState)(!1),_=n(p),h=(0,E.useRef)(null),v=(0,E.useRef)(null),g=(0,E.useRef)(null),{revolutPrbRef:b}=S({paymentOptions:{currency:_.order_currency,amount:e.cartTotal.value,validate:()=>new Promise(((e,t)=>{m(!0),(0,r.select)(i).hasValidationErrors()&&(m(!1),t("Checkout form is incomplete")),y(_).then((r=>{h.current=r.revolut_order_public_id,c(),document.addEventListener("checkout_success",(()=>{e(!0)})),document.addEventListener("checkout_fail",(()=>{m(!1),t("Something went wrong")}))}))})),createOrder:()=>({publicId:h.current})},onSuccess:()=>{m(!0),w({response:v.current,paymentMethod:p,shouldSavePayment:0})},onError:e=>{m(!1),g.current&&g.current.resolve((e=>({type:s.responseTypes.ERROR,message:e,retry:!0,messageContext:s.noticeContexts.PAYMENTS}))(e))}},[e.cartTotal.value]);return(0,E.useEffect)((()=>{const e=u((async e=>new Promise((t=>{m(!1),v.current=e,document.dispatchEvent(new CustomEvent("checkout_success")),g.current={resolve:t}})))),t=l((e=>{e&&e.paymentDetails&&e.paymentDetails.wc_order_id||document.dispatchEvent(new CustomEvent("checkout_fail"))}));return()=>{e(),t()}}),[u,l]),R(),(0,f.createElement)(f.Fragment,null," ",(0,f.createElement)(t.LoadingMask,{showSpinner:!0,isLoading:d||a.isProcessing||a.isComplete},(0,f.createElement)("div",{ref:b})))}),null),edit:(0,f.createElement)("p",null,a("Google/Apple Pay block is not available in editor mode")),ariaLabel:"Google Pay/Apple Pay",canMakePayment:()=>B.can_make_payment,paymentMethodId:"revolut_payment_request",supports:{features:["products"]}},$=U,{registerPaymentMethod:j,registerExpressPaymentMethod:G}=window.wc.wcBlocksRegistry;m?(G(Y),G($)):(j(A),j(Y),j($))})();